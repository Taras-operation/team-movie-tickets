<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö–≤–∏—Ç–æ–∫</title>
  <style>
    :root{--bg:#0b0f17;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--line:#1f2937;--ok:#22c55e;--warn:#f59e0b;--btn:#2563eb;--btn2:#374151}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial}
    .wrap{max-width:720px;margin:0 auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    h1{margin:0 0 10px;font-size:20px}
    .muted{color:var(--muted)}
    .row{display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-bottom:1px dashed #223047}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700}
    .paid{background:rgba(34,197,94,.15);color:var(--ok);border:1px solid rgba(34,197,94,.35)}
    .entr{background:rgba(245,158,11,.15);color:var(--warn);border:1px solid rgba(245,158,11,.35)}
    .code{font-size:28px;font-weight:900;letter-spacing:1px;margin-top:8px;word-break:break-word}
    .btn{display:inline-block;background:var(--btn);color:#fff;padding:10px 12px;border-radius:10px;text-decoration:none;border:none;cursor:pointer}
    .btn.secondary{background:var(--btn2)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .err{color:#fca5a5}
    ul{margin:6px 0 0;padding-left:18px}

    /* ‚úÖ —á—É—Ç—å –ª—É—á—à–µ –Ω–∞ –º–æ–±–∏–ª–∫–µ */
    @media (max-width:520px){
      .wrap{padding:12px}
      h1{font-size:18px}
      .row{flex-direction:column;align-items:flex-start}
      .btns .btn{flex:1;min-width:0}
    }

    /* ‚úÖ –ø–µ—á–∞—Ç—å –≤ PDF */
    @media print{
      body{background:#fff;color:#000}
      .wrap{max-width:720px;padding:0}
      .no-print{display:none !important}
      .card{border:1px solid #ddd;background:#fff}
      .muted{color:#444}
      .row{border-bottom:1px dashed #ccc}
      .code{color:#000}
    }
  </style>
</head>
<body>
<div class="wrap">
  <!-- ‚úÖ –≠—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–æ—Ç –±–ª–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ–º —Å–æ—Ö—Ä–∞–Ω—è—Ç—å -->
  <div class="card" id="ticketCard">
    <h1>üéü –ö–≤–∏—Ç–æ–∫ –Ω–∞ –∑–∞–∫—Ä–∏—Ç–∏–π –ø–æ–∫–∞–∑</h1>
    <div class="muted">–ü–æ–∫–∞–∂—ñ—Ç—å —Ü–µ–π –∫–≤–∏—Ç–æ–∫ –Ω–∞ –≤—Ö–æ–¥—ñ.</div>

    <div style="margin-top:12px" id="content">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
  </div>

  <!-- ‚úÖ –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è/–ø–µ—Ä–µ—Ö–æ–¥–∞ -->
  <div class="btns no-print">
    <button class="btn secondary" id="btnPng">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PNG</button>
    <button class="btn secondary" id="btnPdf">üñ® –ó–±–µ—Ä–µ–≥—Ç–∏ —è–∫ PDF</button>
    <a class="btn" href="index.html">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –≤–∏–±–æ—Ä—É –º—ñ—Å—Ü—å</a>
  </div>

  <div class="muted no-print" id="dlHint" style="margin-top:8px;font-size:12px;display:none"></div>
</div>

<!-- ‚úÖ html2canvas –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è PNG -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxUdvb-OyoYtDk8kn2jV-wyA7jYDtiWdJlKlitHN_v-BkOmamLtWby82bUnKsU_5D8Mow/exec";

  function qs(name){
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  }

  function esc(s){
    return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function safeSeatList(seatsStr){
    // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤:
    // "1-1,1-2" –∏–ª–∏ "r1-s1,r1-s2"
    const raw = String(seatsStr||'')
      .split(',')
      .map(s=>s.trim())
      .filter(Boolean);

    const out = [];
    for (const s of raw){
      let m = s.match(/^(\d{1,2})-(\d{1,2})$/);
      if (m) { out.push({row:m[1], seat:m[2]}); continue; }

      m = s.match(/^r(\d{1,2})-s(\d{1,2})$/i);
      if (m) { out.push({row:m[1], seat:m[2]}); continue; }

      // –µ—Å–ª–∏ –ø—Ä–∏–ª–µ—Ç–µ–ª–æ —á—Ç–æ-—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ–µ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –±–∏–ª–µ—Ç
    }
    return out;
  }

  async function loadTicket(){
    const orderId = qs('order_id');
    const el = document.getElementById('content');
    if (!orderId){
      el.innerHTML = `<div class="err">–ù–µ–º–∞—î order_id —É –ø–æ—Å–∏–ª–∞–Ω–Ω—ñ.</div>`;
      return;
    }

    const url = `${API_URL}?action=ticket&order_id=${encodeURIComponent(orderId)}`;
    const res = await fetch(url, { method:'GET' });
    const data = await res.json();

    if (!data.ok){
      if (data.error === 'expired') {
        el.innerHTML = `<div class="err">–ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å (10 —Ö–≤ –º–∏–Ω—É–ª–æ). –°–ø—Ä–æ–±—É–π—Ç–µ –æ–±—Ä–∞—Ç–∏ –º—ñ—Å—Ü—è –∑–Ω–æ–≤—É.</div>`;
        return;
      }
      el.innerHTML = `<div class="err">–ü–æ–º–∏–ª–∫–∞: ${esc(data.error || 'unknown')}</div>`;
      return;
    }

    const t = data.ticket;
    const seats = safeSeatList(t.seats);

    let badge = '';
    if (t.status === 'paid') badge = `<span class="badge paid">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ –æ–Ω–ª–∞–π–Ω</span>`;
    else if (t.status === 'entrance') badge = `<span class="badge entr">‚è≥ –û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –≤—Ö–æ–¥—ñ</span>`;
    else if (t.status === 'reserved') badge = `<span class="badge entr">‚è≥ –ó–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–æ (–æ—á—ñ–∫—É—î –æ–ø–ª–∞—Ç–∏)</span>`;
    else badge = `<span class="badge entr">–°—Ç–∞—Ç—É—Å: ${esc(t.status)}</span>`;

    el.innerHTML = `
      <div class="row"><div class="muted">–ü–æ–∫—É–ø–µ—Ü—å</div><div><b>${esc(t.name)}</b></div></div>
      <div class="row"><div class="muted">–¢–µ–ª–µ—Ñ–æ–Ω</div><div>${esc(t.phone)}</div></div>
      <div class="row"><div class="muted">–ú—ñ—Å—Ü—è</div><div>
        <ul>${
          seats.length
            ? seats.map(x => `<li>–†—è–¥ ${esc(x.row)}, –º—ñ—Å—Ü–µ ${esc(x.seat)}</li>`).join('')
            : `<li class="muted">–ú—ñ—Å—Ü—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</li>`
        }</ul>
      </div></div>
      <div style="margin-top:10px">${badge}</div>
      <div style="margin-top:10px" class="muted">–ö–æ–¥ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è</div>
      <div class="code">${esc(t.order_id)}</div>
    `;
  }

  // ‚úÖ –°–∫–∞—á–∞—Ç—å PNG
  async function downloadPNG(){
    const hint = document.getElementById('dlHint');
    hint.style.display = 'block';
    hint.textContent = '–ì–æ—Ç—É—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è‚Ä¶';

    const orderId = qs('order_id') || 'ticket';
    const node = document.getElementById('ticketCard');

    try{
      // —É–≤–µ–ª–∏—á–∏–º —á–µ—Ç–∫–æ—Å—Ç—å
      const canvas = await html2canvas(node, { scale: 2, backgroundColor: null, useCORS: true });
      const dataUrl = canvas.toDataURL('image/png');

      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = `ticket_${orderId}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      hint.textContent = '–ì–æ—Ç–æ–≤–æ ‚úÖ PNG –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.';
      setTimeout(()=> hint.style.display='none', 2500);
    } catch(e){
      hint.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑—Ä–æ–±–∏—Ç–∏ PNG. –°–ø—Ä–æ–±—É–π—Ç–µ –∫–Ω–æ–ø–∫—É PDF –∞–±–æ —ñ–Ω—à–∏–π –±—Ä–∞—É–∑–µ—Ä.';
    }
  }

  // ‚úÖ PDF —á–µ—Ä–µ–∑ print (–Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –≤—ã–±–∏—Ä–∞–µ—à—å "Save as PDF")
  function downloadPDF(){
    window.print();
  }

  document.getElementById('btnPng').addEventListener('click', downloadPNG);
  document.getElementById('btnPdf').addEventListener('click', downloadPDF);

  loadTicket();
</script>
</body>
</html>
