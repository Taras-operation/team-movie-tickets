<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ö–≤–∏—Ç–∫–∏ ‚Äî –ó–∞–∫—Ä–∏—Ç–∏–π –ø–æ–∫–∞–∑</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --free:#22c55e; --reserved:#f59e0b; --taken:#ef4444; --selected:#60a5fa;
      --btn:#2563eb; --btn2:#374151; --line:#1f2937;
      --seatBg:#0f172a;
      --seatBorder:#334155;
      --seatmapBg: rgba(255,255,255,0.03);
      --seatmapBorder: rgba(255,255,255,0.07);
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-text-size-adjust:100%;
    }

    .wrap{max-width:1500px;margin:0 auto;padding:18px}
    .top{display:flex;gap:12px;align-items:flex-start;flex-wrap:nowrap}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    h1{margin:0 0 8px;font-size:20px}
    .muted{color:var(--muted)}

    .title-center{text-align:center;padding: 6px 6px 2px;}
    .title-center h1{margin:0;font-size:22px;font-weight:800;letter-spacing:.2px}
    .session-info{margin-top:8px}
    .session-main{font-size:15px;font-weight:700;color:var(--text)}
    .session-sub{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.45}
    .session-hint{margin-top:10px;font-size:12px;color:var(--muted)}

    .seatmap{
      margin-top:12px;
      background: var(--seatmapBg);
      border: 1px solid var(--seatmapBorder);
      border-radius: 16px;
      padding: 14px 14px 10px;
      overflow: visible;
    }
    .seatmap-inner{width:100%;overflow-x:auto;padding-bottom:6px;-webkit-overflow-scrolling:touch}

    .screen-wrap{text-align:center;color:var(--muted)}
    .screen-title{font-size:12px;letter-spacing:1px;margin-bottom:6px}
    .screen-bar{
      margin:0 auto 14px;
      width:100%;
      max-width:760px;
      height:10px;
      background:linear-gradient(to right, rgba(120,180,255,0.10), rgba(120,180,255,0.55), rgba(120,180,255,0.10));
      border-radius:0 0 120px 120px;
      box-shadow:0 8px 25px rgba(120,180,255,0.20);
    }

    .hall-grid{
      display:grid;
      grid-template-columns:28px 1fr 28px;
      row-gap:10px;
      align-items:center;
      min-width:760px;
    }
    .row-label{opacity:.7;font-size:13px;font-variant-numeric:tabular-nums;text-align:center;user-select:none}
    .seats{display:flex;justify-content:center;gap:6px;flex-wrap:nowrap;flex-direction:row-reverse}

    button.seat{
      position:relative;
      width:32px;height:32px;border-radius:8px;border:1px solid var(--seatBorder);
      background:var(--seatBg);color:var(--text);cursor:pointer;
      font-size:12px;font-variant-numeric:tabular-nums;
      display:flex;align-items:center;justify-content:center;
      user-select:none;
      transition:transform .08s ease, box-shadow .08s ease;
    }
    button.seat:hover{transform:scale(1.06);box-shadow:0 0 10px rgba(96,165,250,.22)}
    button.seat.free{border-color:rgba(34,197,94,.45)}
    button.seat.reserved{border-color:rgba(245,158,11,.55)}
    button.seat.taken{border-color:rgba(239,68,68,.55);opacity:.55;cursor:not-allowed}
    button.seat.selected{outline:2px solid var(--selected);outline-offset:1px}

    button.seat.vip{border-color:rgba(239,68,68,.85);background:rgba(239,68,68,0.06)}
    button.seat.vip::after{content:"‚òÖ";position:absolute;top:-6px;right:-6px;font-size:10px;color:rgba(239,68,68,.95)}

    .legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;font-size:12px;opacity:.9}
    .dot{width:10px;height:10px;border-radius:3px;display:inline-block;margin-right:6px}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{border:none;border-radius:10px;padding:10px 12px;color:white;cursor:pointer}
    .btn.primary{background:var(--btn)}
    .btn.secondary{background:var(--btn2)}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .side{width:360px;min-width:360px;flex:0 0 360px}
    .sel-list{margin:8px 0 0;padding:0;list-style:none}
    .sel-list li{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #223047}
    .price{font-variant-numeric:tabular-nums}

    .prices-card{padding:12px}
    .prices-title{font-size:14px;font-weight:800;margin:0 0 10px}
    .prices-list{display:flex;flex-direction:column;gap:8px}
    .price-row{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.03);border-radius:12px}
    .price-row .left{color:var(--muted)}
    .price-row .right{font-weight:800}
    .price-row.vip{border-color:rgba(239,68,68,.25); background: rgba(239,68,68,0.06);}

    .side-stack{display:flex;flex-direction:column;gap:10px}

    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none;align-items:center;justify-content:center;padding:16px;
      padding-bottom: max(16px, env(safe-area-inset-bottom));
    }
    .modal{max-width:560px;width:100%}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input{
      width:100%;padding:10px;border-radius:10px;border:1px solid #334155;
      background:#0b1220;color:var(--text);
      font-size:14px;
    }
    .hr{height:1px;background:#223047;margin:12px 0}

    .paybox{
      background:#0b1220;border:1px solid #223047;border-radius:12px;padding:12px;
      display:none;
    }

    .timer{font-size:16px;font-weight:700}

    .toast{margin-top:10px;color:#fca5a5}
    .toast.info{color:#93c5fd}
    .toast.ok{color:#86efac}
    .toast.error{color:#fca5a5}

    /* ====== Responsive (–æ–±—â–∞—è) ====== */
    @media (max-width:1100px){
      .top{flex-wrap:wrap}
      .side{width:100%;min-width:0;flex:1}
    }

    /* ====== MOBILE UPGRADE (–¥–µ—Å–∫—Ç–æ–ø –Ω–µ —Ç—Ä–æ–≥–∞–µ–º) ====== */
    .mobile-bar{display:none}

    @media (max-width:520px){
      .wrap{padding:12px}
      .card{border-radius:16px;padding:12px}

      /* –¢–µ–∫—Å—Ç—ã/–∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤–ª–µ–∑–∞—é—Ç */
      .title-center{padding:4px 2px 0}
      .title-center h1{
        font-size:clamp(16px, 5vw, 20px);
        line-height:1.2;
        word-break:break-word;
      }
      .session-main{
        font-size:clamp(12px, 3.6vw, 14px);
        line-height:1.35;
        word-break:break-word;
      }
      .session-sub{
        font-size:clamp(11px, 3.3vw, 13px);
        line-height:1.35;
        word-break:break-word;
      }
      .session-hint{
        font-size:clamp(11px, 3.2vw, 12px);
        line-height:1.35;
      }

      /* –°—Ö–µ–º–∞: —á—É—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
      .seatmap{padding:10px}
      button.seat{width:28px;height:28px;border-radius:7px;font-size:12px}
      .hall-grid{grid-template-columns:22px 1fr 22px;row-gap:8px}
      .legend{gap:10px;font-size:12px}

      /* –°–∞–π–¥–±–∞—Ä: –æ–∫, –Ω–æ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã -> –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
      .actions{display:none}
      #syncStatus{padding-bottom:76px} /* —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –Ω–µ –ø—Ä—è—Ç–∞–ª—Å—è –∑–∞ –Ω–∏–∂–Ω–µ–π –ø–∞–Ω–µ–ª—å—é */

      /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
      .mobile-bar{
        display:flex;
        position:fixed;
        left:0;right:0;bottom:0;
        padding:10px 12px;
        padding-bottom:max(10px, env(safe-area-inset-bottom));
        background:rgba(17,24,39,0.92);
        border-top:1px solid rgba(255,255,255,0.08);
        backdrop-filter: blur(10px);
        z-index:50;
        gap:10px;
        align-items:center;
        justify-content:space-between;
      }
      .mobile-bar .sum{
        display:flex;flex-direction:column;gap:2px;
        min-width:120px;
      }
      .mobile-bar .sum .label{font-size:11px;color:var(--muted)}
      .mobile-bar .sum .value{font-size:14px;font-weight:800}
      .mobile-bar .mb-actions{
        display:flex;gap:8px;flex:1;justify-content:flex-end;
      }
      .mobile-bar .btn{padding:12px 12px;border-radius:12px;min-width:120px}

      /* –ú–æ–¥–∞–ª–∫–∞: –±–µ–∑ iOS zoom –∏ –≤–ª–µ–∑–∞–µ—Ç */
      .modal-backdrop{align-items:flex-start;justify-content:center}
      .modal{margin-top:12px;max-height:92vh;overflow:auto}
      input{font-size:16px} /* –í–ê–ñ–ù–û: iOS –ø–µ—Ä–µ—Å—Ç–∞–µ—Ç –∑—É–º–∏—Ç—å */
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="card" style="flex:1;min-width:420px">
      <div class="title-center">
        <h1>üé¨ –ó–∞–∫—Ä–∏—Ç–∏–π –ø–æ–∫–∞–∑ —Ñ—ñ–ª—å–º—É Vuso Wings 2 years</h1>
        <div class="session-info">
          <div class="session-main">
            –ü–æ–Ω–µ–¥—ñ–ª–æ–∫, 22 –ª–∏—Å—Ç–æ–ø–∞–¥–∞ ‚Ä¢ –ü–æ—á–∞—Ç–æ–∫ —Å–µ–∞–Ω—Å—É <b>18:30</b>
          </div>
          <div class="session-sub">
            –º. –ö–∏—ó–≤, –≤—É–ª. –ê–Ω—Ç–æ–Ω–æ–≤–∏—á–∞ (–ì–æ—Ä—å–∫–æ–≥–æ), 50 ‚Ä¢ –∫—ñ–Ω–æ—Ç–µ–∞—Ç—Ä DeLuxe<br>
            –ó–∞–ª: <b>–ß–µ—Ä–≤–æ–Ω–∏–π</b>
          </div>
        </div>
        <div class="session-hint">
          –û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ü—è –≤ –∑–∞–ª—ñ. –î–ª—è –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–∏ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è —Ç—Ä–∏–º–∞—î—Ç—å—Å—è <b>10 —Ö–≤</b>.
        </div>
      </div>

      <div class="seatmap">
        <div class="seatmap-inner">
          <div class="screen-wrap">
            <div class="screen-title">–ï–ö–†–ê–ù</div>
            <div class="screen-bar"></div>
          </div>
          <div class="hall-grid" id="hall"></div>
        </div>

        <div class="legend">
          <span><span class="dot" style="background:var(--free)"></span>–í—ñ–ª—å–Ω–µ</span>
          <span><span class="dot" style="background:var(--reserved)"></span>–ó–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–æ</span>
          <span><span class="dot" style="background:var(--taken)"></span>–ó–∞–π–Ω—è—Ç–µ</span>
          <span><span class="dot" style="background:var(--selected)"></span>–û–±—Ä–∞–Ω–æ</span>
        </div>
      </div>
    </div>

    <div class="side">
      <div class="side-stack">
        <div class="card prices-card">
          <div class="prices-title">–¶—ñ–Ω–∏ –ø–æ —Ä—è–¥–∞—Ö</div>
          <div class="prices-list">
            <div class="price-row"><div class="left">1‚Äì5 —Ä—è–¥</div><div class="right">200 –≥—Ä–Ω</div></div>
            <div class="price-row"><div class="left">6‚Äì7 —Ä—è–¥</div><div class="right">300 –≥—Ä–Ω</div></div>
            <div class="price-row"><div class="left">8‚Äì9 —Ä—è–¥</div><div class="right">400 –≥—Ä–Ω</div></div>
            <div class="price-row vip"><div class="left">10 —Ä—è–¥ (VIP)</div><div class="right">800 –≥—Ä–Ω</div></div>
          </div>
        </div>

        <div class="card">
          <h1 style="font-size:16px;margin-bottom:6px">–í–∞—à—ñ –º—ñ—Å—Ü—è</h1>
          <div class="muted" id="selHint">–ö–ª—ñ–∫–Ω—ñ—Ç—å –ø–æ –º—ñ—Å—Ü—è—Ö —É —Å—Ö–µ–º—ñ.</div>
          <ul class="sel-list" id="selList"></ul>

          <div style="margin-top:10px;display:flex;justify-content:space-between">
            <div class="muted">–†–∞–∑–æ–º:</div>
            <div class="price" id="totalPrice">0 –≥—Ä–Ω</div>
          </div>

          <div class="actions">
            <button class="btn secondary" id="btnClear" disabled>–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            <button class="btn primary" id="btnConfirm" disabled>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
          </div>

          <div class="muted" style="margin-top:10px" id="syncStatus">–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è‚Ä¶</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MOBILE sticky bar (—Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ) -->
<div class="mobile-bar" id="mobileBar">
  <div class="sum">
    <div class="label" id="mbHint">–†–∞–∑–æ–º</div>
    <div class="value" id="mbTotal">0 –≥—Ä–Ω</div>
  </div>
  <div class="mb-actions">
    <button class="btn secondary" id="btnClearMobile" disabled>–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    <button class="btn primary" id="btnConfirmMobile" disabled>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="card modal">
    <h1 style="font-size:18px">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h1>
    <div class="muted">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –¥–∞–Ω—ñ –ø–æ–∫—É–ø—Ü—è. –î–∞–ª—ñ ‚Äî –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –Ω–∞ 10 —Ö–≤ —ñ –æ–ø–ª–∞—Ç–∞ (–∫–∞—Ä—Ç–∫–∞/–±–∞–Ω–∫–∞).</div>

    <div class="hr"></div>

    <div class="grid">
      <div>
        <label>–Ü–º º—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ</label>
        <input id="inpName" placeholder="–ù–∞–ø—Ä. –Ü–≤–∞–Ω –Ü–≤–∞–Ω–æ–≤" autocomplete="name" />
      </div>
      <div>
        <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É</label>
        <input id="inpPhone" placeholder="+380..." inputmode="tel" autocomplete="tel" />
      </div>
    </div>

    <div class="toast error" id="modalErr" style="display:none"></div>

    <div class="hr"></div>

    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn secondary" id="btnReserve">–°—Ç–≤–æ—Ä–∏—Ç–∏ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è</button>
      <button class="btn secondary" id="btnX">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>

    <div class="paybox" id="paybox">
      <div class="hr"></div>

      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap">
        <div>
          <div class="muted">–ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –¥—ñ—î —â–µ:</div>
          <div class="timer" id="timer">10:00</div>
        </div>
        <div style="text-align:right">
          <div class="muted">–î–æ —Å–ø–ª–∞—Ç–∏:</div>
          <div class="price" id="modalTotal">0 –≥—Ä–Ω</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="muted" style="margin-bottom:6px">–û–ø–ª–∞—Ç–∞ (–∫–∞—Ä—Ç–∫–∞ / –±–∞–Ω–∫–∞):</div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
        <div style="font-weight:700;letter-spacing:.3px">
          üí≥ <span id="payCard">4874 1000 2272 4531</span>
        </div>
        <button class="btn secondary" id="btnCopyCard" type="button" style="padding:10px 12px">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn primary" id="btnOpenJar" href="https://send.monobank.ua/jar/7CyevktNVR" target="_blank" rel="noopener" style="text-decoration:none;display:inline-flex;align-items:center;gap:8px">
          üîó –í—ñ–¥–∫—Ä–∏—Ç–∏ –±–∞–Ω–∫—É
        </a>
      </div>

      <div class="muted" style="margin-top:8px">1) –û–ø–ª–∞—Ç—ñ—Ç—å (–∫–∞—Ä—Ç–∫–æ—é –∞–±–æ –≤ –±–∞–Ω—Ü—ñ) ‚Üí 2) –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ‚Äú–Ø –æ–ø–ª–∞—Ç–∏–≤(–ª–∞)‚Äù.</div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn primary" id="btnIpaid" disabled>–Ø –æ–ø–ª–∞—Ç–∏–≤(–ª–∞)</button>
      </div>

      <div class="toast" id="payErr" style="display:none"></div>
    </div>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const API_URL = "https://script.google.com/macros/s/AKfycbzIgSrWvVTLfS2eiJVsnK9adW6XUcp6QWG7UtfpUIwNFZGCZG4INy9NQNs_UxZenx91Xg/exec";

  const PRICE_BY_ROW = {
    1:200, 2:200, 3:200, 4:200, 5:200,
    6:300, 7:300,
    8:400, 9:400,
    10:800
  };

  const PAY_CARD = "4874 1000 2272 4531";
  const PAY_JAR_URL = "https://send.monobank.ua/jar/7CyevktNVR";

  const HALL_ROWS = [
    { row: 1, seats: range(1,6),  vip:false },
    { row: 2, seats: range(1,14), vip:false },
    { row: 3, seats: range(1,18), vip:false },
    { row: 4, seats: range(1,20), vip:false },
    { row: 5, seats: range(1,20), vip:false },
    { row: 6, seats: range(1,20), vip:false },
    { row: 7, seats: range(1,20), vip:false },
    { row: 8, seats: range(1,20), vip:false },
    { row: 9, seats: range(1,20), vip:false },
    { row: 10,seats: range(1,16), vip:true  },
  ];
  function range(a,b){ const out=[]; for(let i=a;i<=b;i++) out.push(i); return out; }

  // ====== STATE ======
  const selected = new Set();
  let seatsReserved = new Set();
  let seatsTaken = new Set();
  let seatsHoldMinutes = 10;

  // ====== UI refs ======
  const hallEl = document.getElementById('hall');
  const selListEl = document.getElementById('selList');
  const totalPriceEl = document.getElementById('totalPrice');
  const btnClear = document.getElementById('btnClear');
  const btnConfirm = document.getElementById('btnConfirm');
  const selHint = document.getElementById('selHint');
  const syncStatus = document.getElementById('syncStatus');

  // mobile bar refs
  const mobileBar = document.getElementById('mobileBar');
  const mbTotal = document.getElementById('mbTotal');
  const mbHint = document.getElementById('mbHint');
  const btnClearMobile = document.getElementById('btnClearMobile');
  const btnConfirmMobile = document.getElementById('btnConfirmMobile');

  const modalBackdrop = document.getElementById('modalBackdrop');
  const inpName = document.getElementById('inpName');
  const inpPhone = document.getElementById('inpPhone');
  const modalErr = document.getElementById('modalErr');

  const paybox = document.getElementById('paybox');
  const modalTotal = document.getElementById('modalTotal');
  const timerEl = document.getElementById('timer');
  const btnReserve = document.getElementById('btnReserve');
  const btnIpaid = document.getElementById('btnIpaid');
  const payErr = document.getElementById('payErr');
  const btnX = document.getElementById('btnX');

  const payCardEl = document.getElementById('payCard');
  const btnCopyCard = document.getElementById('btnCopyCard');
  const btnOpenJar = document.getElementById('btnOpenJar');

  payCardEl.textContent = PAY_CARD;
  btnOpenJar.href = PAY_JAR_URL;

  let timerInterval = null;
  let reservedUntilMs = null;
  let pendingOrderId = null;

  function seatKey(row, seat){ return `${row}-${seat}`; }
  function getSeatPrice(row){ return PRICE_BY_ROW[row] ?? 0; }

  function seatStatusClass(key){
    if (seatsTaken.has(key)) return 'taken';
    if (seatsReserved.has(key)) return 'reserved';
    return 'free';
  }

  function renderHall(){
    hallEl.innerHTML = '';
    HALL_ROWS.forEach(r => {
      const left = document.createElement('div');
      left.className = 'row-label';
      left.textContent = r.row;

      const seats = document.createElement('div');
      seats.className = 'seats';

      r.seats.forEach(seatNum => {
        const key = seatKey(r.row, seatNum);
        const btn = document.createElement('button');
        btn.className = `seat ${seatStatusClass(key)} ${r.vip ? 'vip' : ''}`;
        btn.textContent = seatNum;

        btn.disabled = seatsTaken.has(key);
        if (selected.has(key)) btn.classList.add('selected');

        btn.addEventListener('click', () => {
          if (seatsTaken.has(key) || seatsReserved.has(key)) return;
          if (selected.has(key)) selected.delete(key);
          else selected.add(key);
          renderHall();
          renderSelection();
        });

        seats.appendChild(btn);
      });

      const right = document.createElement('div');
      right.className = 'row-label';
      right.textContent = r.row;

      hallEl.appendChild(left);
      hallEl.appendChild(seats);
      hallEl.appendChild(right);
    });
  }

  function renderSelection(){
    const keys = Array.from(selected);
    keys.sort((a,b) => {
      const [ra,sa]=a.split('-').map(Number);
      const [rb,sb]=b.split('-').map(Number);
      return ra - rb || sa - sb;
    });

    selListEl.innerHTML = '';
    let total = 0;

    keys.forEach(k => {
      const [row, seat] = k.split('-').map(Number);
      const price = getSeatPrice(row);
      total += price;

      const li = document.createElement('li');
      li.innerHTML = `<span>–†—è–¥ ${row}, –º—ñ—Å—Ü–µ ${seat}</span><span class="price">${price} –≥—Ä–Ω</span>`;
      selListEl.appendChild(li);
    });

    totalPriceEl.textContent = `${total} –≥—Ä–Ω`;
    modalTotal.textContent = `${total} –≥—Ä–Ω`;

    // mobile bar
    mbTotal.textContent = `${total} –≥—Ä–Ω`;
    mbHint.textContent = keys.length ? `–û–±—Ä–∞–Ω–æ: ${keys.length}` : '–†–∞–∑–æ–º';

    const has = keys.length > 0;
    btnClear.disabled = !has;
    btnConfirm.disabled = !has;
    btnClearMobile.disabled = !has;
    btnConfirmMobile.disabled = !has;

    selHint.textContent = has ? `–û–±—Ä–∞–Ω–æ –º—ñ—Å—Ü—å: ${keys.length}` : '–ö–ª—ñ–∫–Ω—ñ—Ç—å –ø–æ –º—ñ—Å—Ü—è—Ö —É —Å—Ö–µ–º—ñ.';
  }

  async function apiGetSeats(){
    const url = `${API_URL}?action=seats`;
    const res = await fetch(url, { method:'GET' });
    return await res.json();
  }

  async function apiCreateOrder(payload){
    const url = `${API_URL}?action=create_order`;
    const res = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function apiConfirmPayment(orderId){
    const url = `${API_URL}?action=confirm_payment`;
    const res = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({ order_id: orderId })
    });
    return await res.json();
  }

  async function syncSeats(){
    try{
      syncStatus.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è‚Ä¶';
      const data = await apiGetSeats();
      if (!data || (data.ok === false && data.error)) throw new Error(data.error);

      seatsReserved = new Set(data.reserved || []);
      seatsTaken = new Set(data.taken || []);
      seatsHoldMinutes = data.hold_minutes || 10;

      for (const k of Array.from(selected)){
        if (seatsTaken.has(k) || seatsReserved.has(k)) selected.delete(k);
      }

      renderHall();
      renderSelection();
      syncStatus.textContent = `–û–Ω–æ–≤–ª–µ–Ω–æ. –¢–∞–π–º–µ—Ä –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è (–æ–Ω–ª–∞–π–Ω): ${seatsHoldMinutes} —Ö–≤`;
    } catch(err){
      syncStatus.textContent = '–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É.';
      console.error(err);
    }
  }

  function openModal(){
    modalErr.style.display = 'none';
    payErr.style.display = 'none';

    paybox.style.display = 'none';
    btnIpaid.disabled = true;

    pendingOrderId = null;
    reservedUntilMs = null;
    stopTimer();

    modalBackdrop.style.display = 'flex';
    btnReserve.disabled = false;

    setTimeout(() => inpName.focus(), 50);
  }

  function closeModal(){
    modalBackdrop.style.display = 'none';
    stopTimer();
  }

  function showModalError(msg){
    modalErr.style.display = 'block';
    modalErr.textContent = msg;
  }

  function showPayMsg(msg, type='info'){
    payErr.style.display = 'block';
    payErr.className = `toast ${type}`;
    payErr.textContent = msg;
  }

  function startTimer(untilMs){
    reservedUntilMs = untilMs;
    tickTimer();
    timerInterval = setInterval(tickTimer, 500);
  }

  function stopTimer(){
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
    reservedUntilMs = null;
    timerEl.textContent = '00:00';
  }

  function tickTimer(){
    if (!reservedUntilMs) { timerEl.textContent='00:00'; return; }
    const left = Math.max(0, reservedUntilMs - Date.now());
    const sec = Math.floor(left/1000);
    const mm = String(Math.floor(sec/60)).padStart(2,'0');
    const ss = String(sec%60).padStart(2,'0');
    timerEl.textContent = `${mm}:${ss}`;
    if (left <= 0){
      stopTimer();
      showPayMsg('–ß–∞—Å –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –≤–∏–π—à–æ–≤. –û–Ω–æ–≤—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É —Ç–∞ –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ü—è —â–µ —Ä–∞–∑.', 'error');
      syncSeats();
      btnIpaid.disabled = true;
      btnReserve.disabled = false;
      pendingOrderId = null;
      paybox.style.display = 'none';
    }
  }

  function getSelectedPayload(){
    const name = inpName.value.trim();
    const phone = inpPhone.value.trim();
    const seats = Array.from(selected);
    const total = seats.reduce((sum, k) => sum + getSeatPrice(Number(k.split('-')[0])), 0);
    return { name, phone, seats, total };
  }

  // ====== actions (–æ–±—â–∏–µ) ======
  function clearSelection(){
    selected.clear();
    renderHall(); renderSelection();
    // –Ω–∞ –º–æ–±–∏–ª–µ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –Ω–∏–∂–Ω—é—é –ø–∞–Ω–µ–ª—å —Å—Ä–∞–∑—É
  }

  btnClear.addEventListener('click', clearSelection);
  btnClearMobile.addEventListener('click', clearSelection);

  btnConfirm.addEventListener('click', openModal);
  btnConfirmMobile.addEventListener('click', openModal);

  btnX.addEventListener('click', closeModal);

  // –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
  btnCopyCard.addEventListener('click', async () => {
    try{
      await navigator.clipboard.writeText(PAY_CARD.replace(/\s+/g,' ').trim());
      showPayMsg('–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ ‚úÖ', 'ok');
    } catch(e){
      showPayMsg('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏. –°–∫–æ–ø—ñ—é–π—Ç–µ –≤—Ä—É—á–Ω—É.', 'error');
    }
  });

  btnReserve.addEventListener('click', async () => {
    modalErr.style.display = 'none';
    payErr.style.display = 'none';

    const { name, phone, seats, total } = getSelectedPayload();
    if (!name) return showModalError('–í–∫–∞–∂—ñ—Ç—å —ñ–º º—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ.');
    if (!phone) return showModalError('–í–∫–∞–∂—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É.');
    if (!seats.length) return showModalError('–û–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–Ω–µ –º—ñ—Å—Ü–µ.');

    btnReserve.disabled = true;

    try{
      const resp = await apiCreateOrder({ name, phone, seats, total, payment_type: 'online' });
      if (!resp.ok){
        if (resp.error === 'seats_conflict') {
          await syncSeats();
          throw new Error('–î–µ—è–∫—ñ –º—ñ—Å—Ü—è —â–æ–π–Ω–æ —Å—Ç–∞–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–º–∏. –û–±–µ—Ä—ñ—Ç—å —ñ–Ω—à—ñ.');
        }
        throw new Error(resp.error || '–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è');
      }

      pendingOrderId = resp.order_id;

      const until = resp.reserved_until
        ? Date.parse(resp.reserved_until)
        : (Date.now() + seatsHoldMinutes*60*1000);

      startTimer(until);

      await syncSeats();

      paybox.style.display = 'block';
      btnIpaid.disabled = false;

      showPayMsg('–ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ ‚úÖ –û–ø–ª–∞—Ç—ñ—Ç—å –∑–∞ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∞–º–∏ —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ‚Äú–Ø –æ–ø–ª–∞—Ç–∏–≤(–ª–∞)‚Äù.', 'ok');
    } catch(e){
      showModalError(String(e.message || e));
      btnReserve.disabled = false;
      paybox.style.display = 'none';
      btnIpaid.disabled = true;
    }
  });

  btnIpaid.addEventListener('click', async () => {
    if (!pendingOrderId) return showPayMsg('–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ‚Äú–°—Ç–≤–æ—Ä–∏—Ç–∏ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è‚Äù.', 'error');

    btnIpaid.disabled = true;
    try{
      const resp = await apiConfirmPayment(pendingOrderId);
      if (!resp.ok){
        if (resp.error === 'expired') throw new Error('–ß–∞—Å –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –≤–∏–π—à–æ–≤. –û–Ω–æ–≤—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É —Ç–∞ –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ü—è –∑–Ω–æ–≤—É.');
        throw new Error(resp.error || '–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è');
      }

      selected.clear();
      await syncSeats();
      window.location.href = `ticket.html?order_id=${encodeURIComponent(pendingOrderId)}`;
    } catch(e){
      showPayMsg(String(e.message || e), 'error');
      btnIpaid.disabled = false;
    }
  });

  renderHall();
  renderSelection();
  syncSeats();
  setInterval(syncSeats, 15000);
</script>
</body>
</html>
