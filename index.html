<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö–≤–∏—Ç–∫–∏ ‚Äî –ó–∞–∫—Ä–∏—Ç–∏–π –ø–æ–∫–∞–∑</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --free:#22c55e; --reserved:#f59e0b; --taken:#ef4444; --selected:#60a5fa;
      --btn:#2563eb; --btn2:#374151; --line:#1f2937;
      --seatBg:#0f172a;
      --seatBorder:#334155;
      --seatmapBg: rgba(255,255,255,0.03);
      --seatmapBorder: rgba(255,255,255,0.07);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial}

    .wrap{max-width:1500px;margin:0 auto;padding:18px}

    .top{display:flex;gap:12px;align-items:flex-start;flex-wrap:nowrap}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}

    h1{margin:0 0 8px;font-size:20px}
    .muted{color:var(--muted)}

    /* ===== Header centered ===== */
    .title-center{
      text-align:center;
      padding: 6px 6px 2px;
    }
    .title-center h1{
      margin: 0;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .session-info{ margin-top: 8px; }
    .session-main{
      font-size: 15px;
      font-weight: 700;
      color: var(--text);
    }
    .session-sub{
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.45;
    }
    .session-hint{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    /* ===== Seatmap ===== */
    .seatmap{
      margin-top:12px;
      background: var(--seatmapBg);
      border: 1px solid var(--seatmapBorder);
      border-radius: 16px;
      padding: 14px 14px 10px;
      overflow: visible;
    }
    .seatmap-inner{
      width:100%;
      overflow-x:auto;
      padding-bottom:6px;
    }

    /* Screen */
    .screen-wrap{ text-align:center; color:var(--muted); }
    .screen-title{ font-size:12px; letter-spacing:1px; margin-bottom:6px; }
    .screen-bar{
      margin: 0 auto 14px;
      width: 100%;
      max-width: 760px;
      height: 10px;
      background: linear-gradient(
        to right,
        rgba(120,180,255,0.10),
        rgba(120,180,255,0.55),
        rgba(120,180,255,0.10)
      );
      border-radius: 0 0 120px 120px;
      box-shadow: 0 8px 25px rgba(120,180,255,0.20);
    }

    /* Hall grid: –ª—ñ–≤–∏–π –Ω–æ–º–µ—Ä | –º—ñ—Å—Ü—è | –ø—Ä–∞–≤–∏–π –Ω–æ–º–µ—Ä */
    .hall-grid{
      display:grid;
      grid-template-columns: 28px 1fr 28px;
      row-gap: 10px;
      align-items:center;
      min-width: 760px;
    }
    .row-label{
      opacity:.7;
      font-size:13px;
      font-variant-numeric: tabular-nums;
      text-align:center;
      user-select:none;
    }

    .seats{
      display:flex;
      justify-content:center;
      gap:6px;
      flex-wrap:nowrap;
      flex-direction: row-reverse; /* 1 —Å–ø—Ä–∞–≤–∞ */
    }

    button.seat{
      position: relative;
      width:32px;height:32px;border-radius:8px;border:1px solid var(--seatBorder);
      background:var(--seatBg);color:var(--text);cursor:pointer;
      font-size:12px;font-variant-numeric:tabular-nums;
      display:flex;align-items:center;justify-content:center;
      user-select:none;
      transition: transform .08s ease, box-shadow .08s ease;
    }
    button.seat:hover{ transform: scale(1.06); box-shadow: 0 0 10px rgba(96,165,250,.22); }
    button.seat.free{border-color:rgba(34,197,94,.45)}
    button.seat.reserved{border-color:rgba(245,158,11,.55)}
    button.seat.taken{border-color:rgba(239,68,68,.55);opacity:.55;cursor:not-allowed}
    button.seat.selected{outline:2px solid var(--selected);outline-offset:1px}

    /* VIP (10 —Ä—è–¥) */
    button.seat.vip{
      border-color:rgba(239,68,68,.85);
      background: rgba(239,68,68,0.06);
    }
    button.seat.vip::after{
      content:"‚òÖ";
      position:absolute;
      top:-6px; right:-6px;
      font-size:10px;
      color: rgba(239,68,68,.95);
    }

    .legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;font-size:12px;opacity:.9}
    .dot{width:10px;height:10px;border-radius:3px;display:inline-block;margin-right:6px}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{border:none;border-radius:10px;padding:10px 12px;color:white;cursor:pointer}
    .btn.primary{background:var(--btn)}
    .btn.secondary{background:var(--btn2)}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    /* Right column */
    .side{width:360px;min-width:360px;flex:0 0 360px}
    .sel-list{margin:8px 0 0;padding:0;list-style:none}
    .sel-list li{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #223047}
    .price{font-variant-numeric:tabular-nums}

    /* Price list card */
    .price-card{padding:12px}
    .price-card h2{margin:0 0 10px;font-size:14px}
    .price-items{display:flex;flex-direction:column;gap:8px}
    .price-item{
      display:flex;justify-content:space-between;align-items:center;
      border:1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.03);
      border-radius:12px;
      padding:10px 12px;
    }
    .price-item .left{color:var(--muted)}
    .price-item .right{font-weight:800}

    /* Tight spacing between price list and "–í–∞—à—ñ –º—ñ—Å—Ü—è" */
    .side-stack{display:flex;flex-direction:column;gap:10px} /* –±—ã–ª–æ –º–Ω–æ–≥–æ ‚Äî –¥–µ–ª–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω–æ */

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{max-width:560px;width:100%}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:var(--text)}
    .hr{height:1px;background:#223047;margin:12px 0}
    .paybox{background:#0b1220;border:1px solid #223047;border-radius:12px;padding:12px}
    .timer{font-size:16px;font-weight:700}

    .toast{margin-top:10px;color:#fca5a5}
    .toast.info{color:#93c5fd}
    .toast.ok{color:#86efac}
    .toast.error{color:#fca5a5}

    @media (max-width:1100px){
      .top{flex-wrap:wrap}
      .side{width:100%;min-width:0;flex:1}
    }
    @media (max-width:520px){
      button.seat{width:28px;height:28px;border-radius:7px}
      .grid{grid-template-columns:1fr}
      .hall-grid{ grid-template-columns: 22px 1fr 22px; row-gap: 8px; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">

    <!-- –õ–ï–í–ê–Ø –ö–ê–†–¢–û–ß–ö–ê -->
    <div class="card" style="flex:1;min-width:420px">
      <div class="title-center">
        <h1>üé¨ –ó–∞–∫—Ä–∏—Ç–∏–π –ø–æ–∫–∞–∑ —Ñ—ñ–ª—å–º—É Vuso Wings 2 years</h1>

        <div class="session-info">
          <div class="session-main">
            –ü–æ–Ω–µ–¥—ñ–ª–æ–∫, 22 –ª–∏—Å—Ç–æ–ø–∞–¥–∞ ‚Ä¢ –ü–æ—á–∞—Ç–æ–∫ —Å–µ–∞–Ω—Å—É <b>18:30</b>
          </div>
          <div class="session-sub">
            –º. –ö–∏—ó–≤, –≤—É–ª. –ê–Ω—Ç–æ–Ω–æ–≤–∏—á–∞ (–ì–æ—Ä—å–∫–æ–≥–æ), 50 ‚Ä¢ –∫—ñ–Ω–æ—Ç–µ–∞—Ç—Ä DeLuxe<br>
            –ó–∞–ª: <b>–ß–µ—Ä–≤–æ–Ω–∏–π</b>
          </div>
        </div>

        <div class="session-hint">
          –û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ü—è –≤ –∑–∞–ª—ñ. –î–ª—è –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–∏ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è —Ç—Ä–∏–º–∞—î—Ç—å—Å—è <b>10 —Ö–≤</b>.
        </div>
      </div>

      <div class="seatmap">
        <div class="seatmap-inner">
          <div class="screen-wrap">
            <div class="screen-title">–ï–ö–†–ê–ù</div>
            <div class="screen-bar"></div>
          </div>
          <div class="hall-grid" id="hall"></div>
        </div>

        <div class="legend">
          <span><span class="dot" style="background:var(--free)"></span>–í—ñ–ª—å–Ω–µ</span>
          <span><span class="dot" style="background:var(--reserved)"></span>–ó–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–æ</span>
          <span><span class="dot" style="background:var(--taken)"></span>–ó–∞–π–Ω—è—Ç–µ</span>
          <span><span class="dot" style="background:var(--selected)"></span>–û–±—Ä–∞–Ω–æ</span>
        </div>
      </div>
    </div>

    <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê (—Ü–µ–Ω—ã —Å–≤–µ—Ä—Ö—É, –Ω–∏–∂–µ "–í–∞—à—ñ –º—ñ—Å—Ü—è") -->
    <div class="side side-stack">

      <!-- –ü–ª–∞—à–∫–∞ —Ü–µ–Ω -->
      <div class="card price-card">
        <h2>–¶—ñ–Ω–∏ –ø–æ —Ä—è–¥–∞—Ö</h2>
        <div class="price-items">
          <div class="price-item"><div class="left">1‚Äì5 —Ä—è–¥</div><div class="right">200 –≥—Ä–Ω</div></div>
          <div class="price-item"><div class="left">6‚Äì7 —Ä—è–¥</div><div class="right">300 –≥—Ä–Ω</div></div>
          <div class="price-item"><div class="left">8‚Äì9 —Ä—è–¥</div><div class="right">400 –≥—Ä–Ω</div></div>
          <div class="price-item"><div class="left">10 —Ä—è–¥ (VIP)</div><div class="right">800 –≥—Ä–Ω</div></div>
        </div>
      </div>

      <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ "–í–∞—à—ñ –º—ñ—Å—Ü—è" -->
      <div class="card">
        <h1 style="font-size:16px;margin-bottom:6px">–í–∞—à—ñ –º—ñ—Å—Ü—è</h1>
        <div class="muted" id="selHint">–ö–ª—ñ–∫–Ω—ñ—Ç—å –ø–æ –º—ñ—Å—Ü—è—Ö —É —Å—Ö–µ–º—ñ.</div>
        <ul class="sel-list" id="selList"></ul>
        <div style="margin-top:10px;display:flex;justify-content:space-between">
          <div class="muted">–†–∞–∑–æ–º:</div>
          <div class="price" id="totalPrice">0 –≥—Ä–Ω</div>
        </div>

        <div class="actions">
          <button class="btn secondary" id="btnClear" disabled>–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          <button class="btn primary" id="btnConfirm" disabled>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
        </div>

        <div class="muted" style="margin-top:10px" id="syncStatus">–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è‚Ä¶</div>
      </div>
    </div>

  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="card modal">
    <h1 style="font-size:18px">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h1>
    <div class="muted">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –¥–∞–Ω—ñ –ø–æ–∫—É–ø—Ü—è. –î–∞–ª—ñ ‚Äî –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –Ω–∞ 10 —Ö–≤ —ñ –æ–ø–ª–∞—Ç–∞ (–∫–∞—Ä—Ç–∫–∞/–±–∞–Ω–∫–∞).</div>

    <div class="hr"></div>

    <div class="grid">
      <div>
        <label>–Ü–º º—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ</label>
        <input id="inpName" placeholder="–ù–∞–ø—Ä. –Ü–≤–∞–Ω –Ü–≤–∞–Ω–æ–≤" />
      </div>
      <div>
        <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É</label>
        <input id="inpPhone" placeholder="+380..." />
      </div>
    </div>

    <div class="toast error" id="modalErr" style="display:none"></div>

    <div class="hr"></div>

    <!-- –®–ê–ì 1: —Ç–æ–ª—å–∫–æ –±—Ä–æ–Ω—å -->
    <div id="reserveOnlyActions" style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn secondary" id="btnReserveOnly">–ó–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏</button>
    </div>
    <div class="toast error" id="reserveOnlyErr" style="display:none"></div>

    <!-- –®–ê–ì 2: –æ–ø–ª–∞—Ç–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –±—Ä–æ–Ω–∏) -->
    <div class="paybox" id="payBox" style="display:none;margin-top:12px">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
        <div>
          <div class="muted">–ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –¥—ñ—î —â–µ:</div>
          <div class="timer" id="timer">10:00</div>
        </div>
        <div style="text-align:right">
          <div class="muted">–î–æ —Å–ø–ª–∞—Ç–∏:</div>
          <div class="price" id="modalTotal">0 –≥—Ä–Ω</div>
        </div>
      </div>
      <div class="hr"></div>

      <div class="muted" style="margin-bottom:6px">–û–ø–ª–∞—Ç–∞ (–∫–∞—Ä—Ç–∫–∞ / –±–∞–Ω–∫–∞):</div>
      <div style="font-weight:600">Monobank / –ö–∞—Ä—Ç–∫–∞ / –ë–∞–Ω–∫–∞: <span id="payRequisites">XXXX XXXX XXXX XXXX</span></div>
      <div class="muted" style="margin-top:6px">1) –û–ø–ª–∞—Ç—ñ—Ç—å ‚Üí 2) –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ‚Äú–Ø –æ–ø–ª–∞—Ç–∏–≤(–ª–∞)‚Äù.</div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn primary" id="btnIpaid" disabled>–Ø –æ–ø–ª–∞—Ç–∏–≤(–ª–∞)</button>
      </div>

      <div class="toast" id="payErr" style="display:none"></div>
    </div>

    <div style="margin-top:12px;display:flex;justify-content:flex-end">
      <button class="btn secondary" id="btnX">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const API_URL = "https://script.google.com/macros/s/AKfycbxUdvb-OyoYtDk8kn2jV-wyA7jYDtiWdJlKlitHN_v-BkOmamLtWby82bUnKsU_5D8Mow/exec";

  const PAY_REQUISITES_TEXT = "–í–°–¢–ê–í–¢–ï_–ù–û–ú–ï–†_–ö–ê–†–¢–ö–ò_–ê–ë–û_–ü–û–°–ò–õ–ê–ù–ù–Ø_–ù–ê_–ë–ê–ù–ö–£";

  // –ü–ª–∞–Ω –∑–∞–ª–∞
  const HALL_ROWS = [
    { row: 1, seats: range(1,6),  vip:false },
    { row: 2, seats: range(1,14), vip:false },
    { row: 3, seats: range(1,18), vip:false },
    { row: 4, seats: range(1,20), vip:false },
    { row: 5, seats: range(1,20), vip:false },
    { row: 6, seats: range(1,20), vip:false },
    { row: 7, seats: range(1,20), vip:false },
    { row: 8, seats: range(1,20), vip:false },
    { row: 9, seats: range(1,20), vip:false },
    { row: 10,seats: range(1,16), vip:true  },
  ];

  function range(a,b){ const out=[]; for(let i=a;i<=b;i++) out.push(i); return out; }

  // ====== PRICING (–ø–æ —Ä—è–¥–∞–º) ======
  function getSeatPrice(row){
    if (row >= 1 && row <= 5) return 200;
    if (row >= 6 && row <= 7) return 300;
    if (row >= 8 && row <= 9) return 400;
    if (row === 10) return 800;
    return 0;
  }

  // ====== STATE ======
  const selected = new Set(); // "row-seat"
  let seatsReserved = new Set();
  let seatsTaken = new Set();
  let seatsHoldMinutes = 10;

  // ====== UI refs ======
  const hallEl = document.getElementById('hall');
  const selListEl = document.getElementById('selList');
  const totalPriceEl = document.getElementById('totalPrice');
  const btnClear = document.getElementById('btnClear');
  const btnConfirm = document.getElementById('btnConfirm');
  const selHint = document.getElementById('selHint');
  const syncStatus = document.getElementById('syncStatus');

  const modalBackdrop = document.getElementById('modalBackdrop');
  const inpName = document.getElementById('inpName');
  const inpPhone = document.getElementById('inpPhone');
  const modalErr = document.getElementById('modalErr');

  const payBox = document.getElementById('payBox');
  const reserveOnlyActions = document.getElementById('reserveOnlyActions');
  const btnReserveOnly = document.getElementById('btnReserveOnly');
  const reserveOnlyErr = document.getElementById('reserveOnlyErr');

  const modalTotal = document.getElementById('modalTotal');
  const payRequisites = document.getElementById('payRequisites');
  const timerEl = document.getElementById('timer');
  const btnIpaid = document.getElementById('btnIpaid');
  const payErr = document.getElementById('payErr');
  const btnX = document.getElementById('btnX');

  payRequisites.textContent = PAY_REQUISITES_TEXT;

  // Timer state
  let timerInterval = null;
  let reservedUntilMs = null;
  let pendingOrderId = null;

  // ====== Helpers ======
  function seatKey(row, seat){ return `${row}-${seat}`; }

  function seatStatusClass(key){
    if (seatsTaken.has(key)) return 'taken';
    if (seatsReserved.has(key)) return 'reserved';
    return 'free';
  }

  // ====== Render Hall ======
  function renderHall(){
    hallEl.innerHTML = '';

    HALL_ROWS.forEach(r => {
      const left = document.createElement('div');
      left.className = 'row-label';
      left.textContent = r.row;

      const seats = document.createElement('div');
      seats.className = 'seats';

      r.seats.forEach(seatNum => {
        const key = seatKey(r.row, seatNum);
        const btn = document.createElement('button');
        btn.className = `seat ${seatStatusClass(key)} ${r.vip ? 'vip' : ''}`;
        btn.textContent = seatNum;

        const isTaken = seatsTaken.has(key);
        btn.disabled = isTaken;

        if (selected.has(key)) btn.classList.add('selected');

        btn.addEventListener('click', () => {
          if (seatsTaken.has(key) || seatsReserved.has(key)) return;
          if (selected.has(key)) selected.delete(key);
          else selected.add(key);
          renderHall();
          renderSelection();
        });

        seats.appendChild(btn);
      });

      const right = document.createElement('div');
      right.className = 'row-label';
      right.textContent = r.row;

      hallEl.appendChild(left);
      hallEl.appendChild(seats);
      hallEl.appendChild(right);
    });
  }

  function renderSelection(){
    const keys = Array.from(selected);
    keys.sort((a,b) => {
      const [ra,sa]=a.split('-').map(Number);
      const [rb,sb]=b.split('-').map(Number);
      return ra - rb || sa - sb;
    });

    selListEl.innerHTML = '';
    let total = 0;

    keys.forEach(k => {
      const [row, seat] = k.split('-').map(Number);
      const price = getSeatPrice(row);
      total += price;

      const li = document.createElement('li');
      li.innerHTML = `<span>–†—è–¥ ${row}, –º—ñ—Å—Ü–µ ${seat}</span><span class="price">${price} –≥—Ä–Ω</span>`;
      selListEl.appendChild(li);
    });

    totalPriceEl.textContent = `${total} –≥—Ä–Ω`;
    modalTotal.textContent = `${total} –≥—Ä–Ω`;

    const has = keys.length > 0;
    btnClear.disabled = !has;
    btnConfirm.disabled = !has;
    selHint.textContent = has ? `–û–±—Ä–∞–Ω–æ –º—ñ—Å—Ü—å: ${keys.length}` : '–ö–ª—ñ–∫–Ω—ñ—Ç—å –ø–æ –º—ñ—Å—Ü—è—Ö —É —Å—Ö–µ–º—ñ.';
  }

  // ====== API ======
  async function apiGetSeats(){
    const url = `${API_URL}?action=seats`;
    const res = await fetch(url, { method:'GET' });
    return await res.json();
  }

  async function apiCreateOrder(payload){
    const url = `${API_URL}?action=create_order`;
    const res = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function apiConfirmPayment(orderId){
    const url = `${API_URL}?action=confirm_payment`;
    const res = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ order_id: orderId })
    });
    return await res.json();
  }

  // ====== Sync seats ======
  async function syncSeats(){
    try{
      syncStatus.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è‚Ä¶';
      const data = await apiGetSeats();
      if (!data || (data.ok === false && data.error)) throw new Error(data.error);

      seatsReserved = new Set(data.reserved || []);
      seatsTaken = new Set(data.taken || []);
      seatsHoldMinutes = data.hold_minutes || data.hold_minutes === 0 ? data.hold_minutes : (data.hold_minutes || 10);

      // –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç–∞–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã ‚Äî —É–±–∏—Ä–∞–µ–º
      for (const k of Array.from(selected)){
        if (seatsTaken.has(k) || seatsReserved.has(k)) selected.delete(k);
      }

      renderHall();
      renderSelection();
      syncStatus.textContent = `–û–Ω–æ–≤–ª–µ–Ω–æ. –¢–∞–π–º–µ—Ä –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è (–æ–Ω–ª–∞–π–Ω): ${seatsHoldMinutes} —Ö–≤`;
    } catch(err){
      syncStatus.textContent = '–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É.';
      console.error(err);
    }
  }

  // ====== Modal logic ======
  function openModal(){
    modalErr.style.display = 'none';
    payErr.style.display = 'none';
    payErr.className = 'toast';
    reserveOnlyErr.style.display = 'none';

    pendingOrderId = null;
    reservedUntilMs = null;
    stopTimer();

    modalBackdrop.style.display = 'flex';
    payRequisites.textContent = PAY_REQUISITES_TEXT;

    // —Å—Ç–∞—Ä—Ç: —Å–∫—Ä—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –±—Ä–æ–Ω—å
    payBox.style.display = 'none';
    reserveOnlyActions.style.display = 'flex';
    btnReserveOnly.disabled = false;
    btnIpaid.disabled = true;

    inpName.focus();
  }

  function closeModal(){
    modalBackdrop.style.display = 'none';
    stopTimer();
  }

  function showModalError(msg){
    modalErr.style.display = 'block';
    modalErr.textContent = msg;
  }

  function showPayMsg(msg, type='info'){
    payErr.style.display = 'block';
    payErr.className = `toast ${type}`;
    payErr.textContent = msg;
  }

  function startTimer(untilMs){
    reservedUntilMs = untilMs;
    tickTimer();
    timerInterval = setInterval(tickTimer, 500);
  }

  function stopTimer(){
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
    reservedUntilMs = null;
    timerEl.textContent = '00:00';
  }

  function tickTimer(){
    const left = Math.max(0, reservedUntilMs - Date.now());
    const sec = Math.floor(left/1000);
    const mm = String(Math.floor(sec/60)).padStart(2,'0');
    const ss = String(sec%60).padStart(2,'0');
    timerEl.textContent = `${mm}:${ss}`;
    if (left <= 0){
      stopTimer();
      showPayMsg('–ß–∞—Å –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –≤–∏–π—à–æ–≤. –û–Ω–æ–≤—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É —Ç–∞ –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ü—è —â–µ —Ä–∞–∑.', 'error');
      syncSeats();
      btnIpaid.disabled = true;
      pendingOrderId = null;

      // –≤–µ—Ä–Ω–µ–º—Å—è –∫ —à–∞–≥—É "–ó–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏"
      payBox.style.display = 'none';
      reserveOnlyActions.style.display = 'flex';
      btnReserveOnly.disabled = false;
    }
  }

  function getSelectedPayload(){
    const name = inpName.value.trim();
    const phone = inpPhone.value.trim();
    const seats = Array.from(selected);
    const total = seats.reduce((sum, k) => sum + getSeatPrice(Number(k.split('-')[0])), 0);
    return { name, phone, seats, total };
  }

  async function createReservation(){
    modalErr.style.display = 'none';
    payErr.style.display = 'none';
    reserveOnlyErr.style.display = 'none';

    const { name, phone, seats, total } = getSelectedPayload();
    if (!name) return showModalError('–í–∫–∞–∂—ñ—Ç—å —ñ–º º—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ.');
    if (!phone) return showModalError('–í–∫–∞–∂—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É.');
    if (!seats.length) return showModalError('–û–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–Ω–µ –º—ñ—Å—Ü–µ.');

    btnReserveOnly.disabled = true;

    try{
      const resp = await apiCreateOrder({ name, phone, seats, total, payment_type: 'online' });
      if (!resp.ok){
        if (resp.error === 'seats_conflict') {
          await syncSeats();
          throw new Error('–î–µ—è–∫—ñ –º—ñ—Å—Ü—è —â–æ–π–Ω–æ —Å—Ç–∞–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–º–∏. –û–±–µ—Ä—ñ—Ç—å —ñ–Ω—à—ñ.');
        }
        throw new Error(resp.error || '–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è');
      }

      pendingOrderId = resp.order_id;
      const until = resp.reserved_until ? Date.parse(resp.reserved_until) : (Date.now() + 10*60*1000);
      startTimer(until);

      await syncSeats();

      // ‚úÖ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É
      reserveOnlyActions.style.display = 'none';
      payBox.style.display = 'block';
      btnIpaid.disabled = false;

      showPayMsg('–ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ ‚úÖ –û–ø–ª–∞—Ç—ñ—Ç—å —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ‚Äú–Ø –æ–ø–ª–∞—Ç–∏–≤(–ª–∞)‚Äù.', 'ok');
    } catch(e){
      reserveOnlyErr.style.display = 'block';
      reserveOnlyErr.textContent = String(e.message || e);
      btnReserveOnly.disabled = false;
    }
  }

  // ====== Buttons ======
  btnClear.addEventListener('click', () => {
    selected.clear();
    renderHall(); renderSelection();
  });

  btnConfirm.addEventListener('click', openModal);
  btnX.addEventListener('click', closeModal);

  btnReserveOnly.addEventListener('click', createReservation);

  btnIpaid.addEventListener('click', async () => {
    if (!pendingOrderId) return showPayMsg('–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ‚Äú–ó–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏‚Äù.', 'error');

    btnIpaid.disabled = true;
    try{
      const resp = await apiConfirmPayment(pendingOrderId);
      if (!resp.ok){
        if (resp.error === 'expired') throw new Error('–ß–∞—Å –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –≤–∏–π—à–æ–≤. –û–Ω–æ–≤—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É —Ç–∞ –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ü—è –∑–Ω–æ–≤—É.');
        throw new Error(resp.error || '–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è');
      }

      selected.clear();
      await syncSeats();
      window.location.href = `ticket.html?order_id=${encodeURIComponent(pendingOrderId)}`;
    } catch(e){
      showPayMsg(String(e.message || e), 'error');
      btnIpaid.disabled = false;
    }
  });

  // ====== Init ======
  renderHall();
  renderSelection();
  syncSeats();
  setInterval(syncSeats, 15000);
</script>
</body>
</html>
